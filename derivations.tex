\documentclass[11pt]{article}
\usepackage{amsmath, amssymb, amsthm, fullpage, setspace, bm, bbm, hyperref, parskip}

\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}
\newcommand{\numbereqn}{\addtocounter{equation}{1}\tag{\theequation}} % use \numberthis to add number in align* mode


\begin{document}
\onehalfspacing

\def\by{\bm{y}} % for a single individual's observations
\def\bY{\bm{Y}} % for all of the observed outcomes

\def\bbeta{\boldsymbol{\beta}}
\def\bgamma{\boldsymbol{\gamma}}

\def\beps{\boldsymbol{\varepsilon}}
\def\bx{\bm{x}}
\def\bX{\bm{X}}
\def\bmu{\boldsymbol{\mu}}
\def\br{\bm{r}}

\def\brf{\bm{brf}}
\def\brp{\bm{brp}}
\def\balpha{\boldsymbol{\alpha}}
\def\bz{\bm{z}}
\def\bsigma{\boldsymbol{\sigma}}
\def\bone{\boldsymbol{1}}

\def\btheta{\boldsymbol{\theta}}
\def\bTheta{\boldsymbol{\Theta}}
\def\balpha{\boldsymbol{\alpha}}

\def\bE{\boldsymbol{\mathcal{E}}} % for the collection of tree ensembles

\def\bR{\bm{R}}

\def\R{\mathbb{R}}
\def\P{\mathbb{P}}
\def\E{\mathbb{E}}

\def\N{\mathcal{N}}

\def\bSigma{\boldsymbol{\Sigma}}
\def\bOmega{\boldsymbol{\Omega}}

We now describe the update of the $m^{\text{th}}$ regression tree $(T_{m}^{(j)}, \bmu^{(j)}_{m})$ in the ensemble $\mathcal{E}_{j}$ used to approximate $\beta_{j}.$
Let $\bE^{-}$ denote the collection of all remaining $M(p+1) - 1$ regression trees, where, for notational compactness, we have suppressed the dependence of this collection on the indices $j$ and $m.$
Additionally, let $\br_{i} = (r_{i1}, \ldots, r_{in_{i}})^{\top}$ be the vector of subject $i$'s \textit{partial residuals} where
$$
r_{it} = R_{it} + x_{itj}g(\bz_{it}; T_{m}^{(j)}, \bmu_{m}^{(j)}),
$$
where we have again suppressed the dependence of $r_{it}$ on $j$ and $m$ for brevity.

Before describing the update of the tree, we require some additional notation.
For an arbitrary decision tree $T$ with $L(T)$ leaves, for each $i = 1, \ldots, n,$ let $I_{i}(\ell;T)$ be the set of indices $t$ such that $\bz_{it}$ is contained in leaf $\ell$ of tree $t.$
In other words, $I_{i}(\ell;T)$ records which observations from subject $i$ are mapped to leaf $\ell$ in tree $T.$
Further, let $\bX_{i}(T)$ be the $n_{i} \times L(T)$ matrix whose $(t,\ell)$ entry is equal to $x_{itj}$ if $t \in I_{i}(\ell,T)$ and is zero otherwise.
With this additional notation, we have $\br_{i} = \bR_{i} + \bX_{i}(T^{(j)}_{m})\bmu^{(j)}_{m}$ for each $i = 1, \ldots, n.$

\textbf{Marginal likelihood of $T_{m}^{(-j)}$, conditional on $\bE^{-}$}

The conditional conjugacy allows us to marginalize out $\bmu$ and compute $p(\bY \vert T, \bE^{-}, \sigma^{2}).$
To this end, observe that
\begin{align*}
p(\bY \vert T, \bmu, \bE^{-}, \sigma^{2}) &= \prod_{i = 1}^{n}{p(\by_{i} \vert T, \bmu, \bE^{-}, \sigma^{2})} \\
&= \prod_{i = 1}^{n}{(2\pi\sigma^{2})^{-\frac{n_{i}}{2}}\lvert \Omega_{i} \rvert^{\frac{1}{2}}\exp\left\{-\frac{1}{2\sigma^{2}}\left(\br_{i} - \bX_{i}(T)\bmu\right)^{\top}\Omega_{i}(\br_{i} - \bX_{i}(T)\bmu)\right\}}
\end{align*}
We additionally have
$$
p(\bmu \vert T) = (2\pi\tau^{2})^{-\frac{L(T)}{2}}\exp\left\{-\frac{(\bmu - \mu_{0}\bone_{L(T)})^{\top}(\bmu - \mu_{0}\bone_{L(T)})}{2\tau^{2}}\right\}
$$

We therefore compute
\begin{align}
p(\bY, \bmu \vert T, \bE^{-}, \sigma^{2}) &= \left(2\pi\sigma^{2}\right)^{-\frac{N}{2}} \times \left(\prod_{i = 1}^{N}{\lvert \Omega_{i} \rvert}\right)^{\frac{1}{2}} \times \left(2\pi \tau^{2}\right)^{-\frac{L(T)}{2}} \times \exp\left\{ -\frac{\tau^{-2}(\bmu - \mu_{0}\bone_{L(T)})^{\top}(\bmu - \mu_{0}\bone_{L(T)})}{2\tau^{2}} \right\} \nonumber \\
&~\times \exp\left\{-\frac{1}{2\sigma^{2}}\sum_{i = 1}^{n}{(\br_{i} - \bX_{i}(T)\bmu)^{\top}\Omega_{i}(\br_{i} - \bX_{i}(T))}\right\} \nonumber \\
~ & ~ \nonumber \\ 
\begin{split}
\label{eq:lil_joint_density}
~ &= \left(2\pi\sigma^{2}\right)^{-\frac{N}{2}} \times \left(\prod_{i = 1}^{n}{\lvert \Omega_{i} \rvert}\right)^{\frac{1}{2}} \times \exp\left\{-\frac{1}{2\sigma^{2}}\sum_{i = 1}^{n}{\br_{i}^{\top}\Omega_{i}\br_{i}}\right\} \\
~ &~\times \left(2\pi\tau^{2}\right)^{-\frac{L(T)}{2}}\exp\left\{-\frac{1}{2}\left[\bmu^{\top}P(T)\bmu - 2\bmu\Theta(T) + \tau^{-2}\mu_{0}^{2}L(T) \right]\right\} 
\end{split}
\end{align}
where
\begin{align*}
P(T) &= \tau^{-2}I_{L(T)} + \sigma^{-2}\sum_{i = 1}^{n}{\bX_{i}(T)^{\top}\Omega_{i}\bX_{i}(T)} \\
\Theta(T) &= \tau^{-2}\mu_{0}\bone_{L(T)} + \sigma^{-2}\sum_{i = 1}^{n}{\bX_{i}(T)^{\top}\Omega_{i}\br_{i}}.
\end{align*} 
Observe that the terms in the first line of Equation~\eqref{eq:lil_joint_density} do not depend on $T$ or $\mu.$
We will collect these terms into a constant $C,$ where we suppress the dependence on $\sigma^{2}, \bOmega$ and the $\br_{i}$'s from the notation.

That is, we have
\begin{align}
\begin{split}
\label{eq:lil_joint_density2}
p(\bY, \bmu \vert T, \bE^{-1}, \sigma^{2}) &= C \times \tau^{-L(T)} \times \exp\left\{-\frac{1}{2}\left[(\bmu - P^{-1}(T)\Theta(T))^{\top}P(T)(\bmu - P^{-1}(T)\Theta(T))\right]\right\} \\
~&~\times \exp\left\{\frac{1}{2}\left[\Theta(T)^{\top}P^{-1}(T)\Theta(T) - L\mu_{0}^{2}\tau^{-2}\right]\right\}
\end{split}
\end{align}

Equation~\eqref{eq:lil_joint_density2} shows that
$$
\bmu \vert T, \bY, \bE^{-1}, \sigma^{2} \sim \mathcal{N}(P^{-1}(T)\Theta(T), P^{-1}(T)).
$$

Further, by integrating out $\bmu$ from the right-hand side of Equation~\eqref{eq:lil_joint_density2}, we compute
\begin{align*}
p(\bY \vert T, \bE^{-1}, \sigma^{2}) &= C \times \tau^{-L(T)} \times \lvert P(T) \rvert^{-\frac{1}{2}} \times \exp\left\{\frac{\Theta(T)^{\top}P(T)^{-1}\Theta(T) - L\mu_{0}^{2}\tau^{-2}}{2}\right\}
\end{align*}

\textbf{Computing $P(T)$ in the general case}. Recall that
$$
P(T) = \tau^{-2}I_{L(T)} + \sigma^{-2}\sum_{i = 1}^{n}{\bX_{i}(T)^{\top}\Omega_{i}\bX_{i}(T)}.
$$

Observe that the $(\ell, \ell')$ entry of $\bX_{i}^{\top}\Omega_{i}\bX_{i}(T)$ is given by
\begin{align*}
(\bX_{i}^{\top}\Omega_{i}\bX_{i}(T))_{\ell,\ell'} &= \sum_{t = 1}^{n_{i}}{\sum_{t' = 1}^{n_{i}}{\omega_{t,t'}(\bX_{i}(T))_{\ell,t}(\bX_{i}(T))_{\ell',t'}}} \\
&= \sum_{t = 1}^{n_{i}}{\sum_{t' = 1}^{n_{i}}{\omega_{itt'}x_{itj}x_{it'j}\mathbbm{1}(t \in I_{i}(\ell;T), t' \in I_{i}(\ell';T))}} \\
&= \sum_{t \in I_{i}(\ell;T)}{\sum_{t' \in I_{i}(\ell';T)}{\omega_{itt'}x_{itj}x_{it'j}}}
\end{align*}



%For a given tree $T$ and leafs $\ell$ and $\ell'$ observe that
%$$
%(P(T))_{\ell,\ell'} = \tau^{-2}\mathbbm{1}(\ell = \ell') + \sigma^{-2}\sum_{i = 1}^{n}{\sum_{t \in I_{i}(\ell;T)}{\sum_{t' \in I_{i}(\ell';T)}{x_{itj}x_{it'j}\omega_{t,t'}}}}
%$$

%To compute $P(T)$ we can start by filling in the lower triangle using a nested for loop.
%The outer loop will loop over the leafs $\ell$ while the inner loop will only loop over the leafs $\ell'$ preceding $\ell.$

\textbf{The independent error case.} 
Suppose first that $\Omega_{i} = I_{n_{i}}$ for each $i = 1, \ldots, n.$
For $\ell \neq \ell'$, since $\omega_{itt'} = \mathbbm{1}(t = t')$ we have
\begin{align*}
(\bX_{i}(T)^{\top}\Omega_{i}\bX_{i}(T))_{\ell,\ell'} &= \sum_{t = 1}^{n_{i}}{\sum_{t' = 1}^{n_{i}}{\omega_{itt'}x_{itj}x_{it'j}\mathbbm{1}(t \in I_{i}(\ell;T), t' \in I_{i}(\ell';T))}} \\
&= \sum_{t = 1}^{n_{i}}{x_{itj}^{2}\mathbbm{1}(t \in I_{i}(\ell;T), t \in I_{i}(\ell';T))} \\
\end{align*}
Since the $t^{\text{th}}$ observation for subject $i$ can be associated to only one leaf in the tree $T,$ we conclude that $P(T)$ is diagonal with diagonal entries
$$
(P(T))_{\ell,\ell} = \tau^{-2}I_{L(T)} + \sigma^{-2}\sum_{i = 1}^{n}{\sum_{t \in I_{i}(\ell;T)}{x_{itj}^{2}}}.
$$

Recall further that
$$
\Theta(T) = \tau^{-2}\mu_{0}\bone_{L(T)} + \sigma^{-2}\sum_{i = 1}^{n}{\bX_{i}^{\top}\Omega_{i}\br_{i}}
$$
When each $\Omega_{i} = I_{n_{i}}$ we have for each $i = 1, \ldots, n,$
\begin{align*}
(\bX_{i}(T)^{\top}\Omega_{i}\br_{i})_{\ell} &= \sum_{t = 1}^{n_{i}}{x_{itj}r_{it}\mathbbm{1}(t \in I_{i}(\ell))} \\
&= \sum_{t \in I_{i}(\ell;T)}{x_{itj}r_{it}}
\end{align*}

Hence
$$
(\Theta(t))_{\ell} = \tau^{-2}\mu_{0} + \sigma^{-2}\sum_{i = 1}^{n}{\sum_{t \in I_{i}(\ell;T)}{x_{itj}r_{it}}}
$$

\textbf{The compound symmetry case}. Suppose that for each $i = 1, \ldots, n$ 
$$
\Omega_{i}^{-1} = (1 - \rho)I_{n_{i}} + \rho \bone_{n_{i}}\bone_{n_{i}}^{\top}.
$$
It is not difficult to verify that in fact
$$
\Omega_{i} = \frac{1}{1 - \rho}I_{n_{i}} - \frac{\rho}{(1 - \rho)^{2} + n_{i}\rho(1 - \rho)}\bone_{n_{i}}\bone_{n_{i}}^{\top}.
$$

We therefore have
$$
\bX_{i}(T)^{\top}\Omega_{i}\bX_{i}(T) = \frac{1}{1 - \rho}\bX_{i}(T)^{\top}\bX_{i}(T) - \frac{\rho}{(1 - \rho)^{2} + n_{i}\rho(1 - \rho)}\bX_{i}(T)^{\top}\bone_{n_{i}}\bone_{n_{i}}^{\top}\bX_{i}(T) 
$$

%From our computation above, we know that
%\begin{align*}
%(\bX_{i}(T)^{\top}\bX_{i}(T))_{\ell,\ell'} &= \sum_{t = 1}^{n_{i}}{x_{itj}^{2}\mathbbm{1}(t \in I_{i}(\ell;T), t \in I_{i}(\ell';T))} \\
%&= \mathbbm{1}(\ell = \ell') \times \sum_{t \in I_{i}(\ell)}{x_{ijt}^{2}}
%\end{align*}

Observe that
\begin{align*}
(\bX_{i}(T)^{\top}\bX_{i}(T))_{\ell,\ell'} &= \sum_{t = 1}^{n_{i}}{x_{itj}^{2} \mathbbm{1}(t \in I_{i}(\ell;T), t \in I_{i}(\ell',T))} \\
~ &= \mathbbm{1}(\ell = \ell') \times \sum_{t \in I_{i}(\ell;T)}{x_{itj}^{2}}
\end{align*}

We further have
\begin{align*}
(\bX_{i}(T)^{\top}\bone_{n_{i}})_{\ell} &= \sum_{t \in I_{i}(\ell;T)}{x_{itj}}
\end{align*}
Hence
$$
(\bX_{i}(T)^{\top}\bone_{n_{i}}\bone_{n_{i}}^{\top}\bX_{i}(T))_{\ell,\ell'} = \left(\sum_{t \in I_{i}(\ell;T)}{x_{itj}}\right) \times \left(\sum_{t' \in I_{i}(\ell';T)}{x_{it'j}}\right)
$$

We conclude that
\begin{align*}
(P(T))_{\ell,\ell'} &= \mathbbm{1}(\ell = \ell') \times \left[\tau^{-2} + \frac{\sigma^{-2}}{1 - \rho} \times \sum_{i = 1}^{n}{\sum_{t \in I_{i}(\ell)}{x_{itj}^{2}}}\right] \\
&~-\frac{\rho}{1 - \rho} \times \sum_{i = 1}^{n}{\frac{1}{1 - \rho + n_{i}\rho} \times \left(\sum_{t \in I_{i}(\ell;T)}{x_{itj}}\right)\left(\sum_{t' \in I_{i}(\ell';T)}{x_{it'j}}\right)}
\end{align*}

Turning our attention to $\Theta(T)$, have
$$
\bX_{i}(T)^{\top}\Omega_{i}\br_{i} = \frac{1}{1-\rho}\bX_{i}(T)^{\top}\br_{i} - \frac{\rho}{1-\rho} \times \frac{1}{1 - \rho + n_{i}\rho} \times \bX_{i}^{\top}\bone_{n_{i}}\bone_{n_{i}}^{\top}\br_{i}
$$

Notice that
$$
(\bX_{i}(T)^{\top}\br_{i})_{\ell} = \sum_{t = 1}^{n_{i}}{x_{itj}r_{it}\times \mathbbm{1}(t \in I_{i}(\ell;T))} = \sum_{t \in I_{i}(\ell;T)}{x_{itj}r_{it}}
$$
and
$$
(\bX_{i}^{\top}\bone_{n_{i}}\bone_{n_{i}}^{\top}\br_{i})_{\ell} = \left(\bone_{n_{i}}^{\top}\br_{i}\right) \times \sum_{t \in I_{i}(\ell;T)}{x_{itj}}
$$

We conclude that
$$
\Theta(T)_{\ell} = \tau^{-2}\mu_{0} + \frac{\sigma^{-2}}{1 - \rho} \times \sum_{i = 1}^{n}{\sum_{t \in I_{i}(\ell;T)}{\left[x_{itj}r_{it} - \frac{\rho \times \bone_{n_{i}}^{\top}\br_{i}}{1 - \rho + n_{i}\rho}x_{itj}\right]}}
$$


%We therefore have
%$$
%\bX_{i}(T)^{\top}\Omega_{i}\bX_{i}(T) = \frac{1}{1 - \rho}\bX_{i}(T)^{\top}\bX_{i}(T) - \frac{\rho}{(1 - \rho)^{2} + n_{i}\rho(1 - \rho)}\bX_{i}(T)^{\top}\bone_{n_{i}}\bone_{n_{i}}^{\top}\bX_{i}(T)
%$$

%We compute the $(\ell, \ell')$ element of $\bX_{i}(T)^{\top}\bX_{i}(T)$:
%$$
%(\bX_{i}(T)^{\top}\bX_{i})_{\ell,\ell'} = \sum_{t \in I_{i}(\ell;T)}{\sum_{t' \in I_{i}(\ell';T')}{x_{itj}x_{it'j}}} = \left(\sum_{t \in I_{i}(\ell)}{x_{itj}}\right) \times \left(\sum_{t' \in I_{i}(\ell';T)}{x_{it'j}}\right).
%$$

%The $\ell$^{\text{th}}$ entry in $\bone_{L(T)}^{\top}\bX_{i}(T)$ is given by
%$$
%\sum_{t \in I_{i}(\ell;T)}{x_{itj}}
%$$

%We further compute 

\end{document}